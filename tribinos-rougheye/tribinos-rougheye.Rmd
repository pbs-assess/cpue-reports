---
title: "Rougheye and Blackspotted complex CPUE"
author: "Sean Anderson"
date: '2018-08-09'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  comment = "#>",
  fig.asp = 0.618,
  echo = TRUE,
  autodep = TRUE,
  cache = TRUE,
  cache.comments = FALSE
)
```

```{r install}
# devtools::install_github("pbs-assess/gfplot", ref = "57488c3")
```

```{r pkgs, cache=FALSE}
library("dplyr")
library("ggplot2")
library("gfplot")
library("here")
ggplot2::theme_set(gfplot::theme_pbs())
```

```{r cpue-plot-glmm-standardizations, echo=FALSE}
source(here("plot.R"))
```

```{r cpue-read-modern}
fi <- here("data/cpue-modern.rds")
if (!file.exists(fi)) {
  d1996 <- gfplot::get_cpue_index(gear = "bottom trawl", min_cpue_year = 1996)
  readr::write_rds(d1996, fi)
} else {
  d1996 <- readr::read_rds(fi)
}
```

Define our fleet:

```{r define-fleet}
define_fleet <- function(area) {
  gfplot::tidy_cpue_index(d1996,
    species_common = "rougheye/blackspotted rockfish complex",
    gear = "BOTTOM TRAWL",
    use_alt_year = FALSE,
    year_range = c(1996, 2017), 
    lat_range = c(48, Inf),
    min_positive_tows = 100,
    min_positive_trips = 5,
    min_yrs_with_trips = 5,
    depth_band_width = 25,
    area_grep_pattern = area,
    depth_bin_quantiles = c(0.001, 0.999),
    min_bin_perc = 0.001,
    lat_band_width = 0.1)
}
dfleet <- define_fleet("^3C|^3D|^5A|^5B|^5C|^5D|^5E|^4B")
```

The most frequent factor levels are the reference levels.

Some basic characteristics:

```{r basic-char}
range(dfleet$best_date)
nrow(dfleet)
table(dfleet$pos_catch)
length(unique(dfleet$vessel))
sum(dfleet$spp_catch) / 1000
range(dfleet$best_depth)
```

Look at depth bins across all fishing events that caught the species:

```{r cpue-depth}
depth_bands <- as.numeric(as.character(unique(dfleet$depth)))
dfleet %>%
  filter(pos_catch == 1) %>% 
  ggplot(aes(best_depth)) +
  geom_histogram(binwidth = 10) +
  ylim(0, NA) +
  geom_vline(xintercept = depth_bands, lty = 2) +
  coord_cartesian(expand = FALSE)
```

Inspect observation counts of for each factor level for positive fishing events only:

```{r enough}
filter(dfleet, pos_catch == 1) %>%
  pull(locality) %>% table()

filter(dfleet, pos_catch == 1) %>%
  pull(depth) %>% table()

filter(dfleet, pos_catch == 1) %>%
  pull(month) %>% table()

filter(dfleet, pos_catch == 1) %>%
  pull(vessel) %>% table()
```

Make bubble plots of trip counts for positive fishing events:

```{r bubble-plots}
dfleet$area <- "3CD5ABCDE4B"
bubble_predictors(dfleet, "locality", reorder_group = TRUE)
dfleet %>% mutate(depth = as.factor(as.character(depth))) %>% 
  bubble_predictors("depth", reorder_group = FALSE)
dfleet %>% mutate(latitude = as.factor(as.character(latitude))) %>% 
  bubble_predictors("latitude", reorder_group = FALSE)
dfleet %>% mutate(month = as.factor(as.character(month))) %>% 
  bubble_predictors("month", reorder_group = FALSE)
bubble_predictors(dfleet, "vessel", reorder_group = TRUE)
```

Distributions through time:

```{r dist}
dfleet %>% mutate(latitude_numer = as.numeric(as.character(latitude))) %>% 
  plot_pcod_dist("latitude_numer")
plot_pcod_dist(dfleet, "best_depth")
filter(dfleet, pos_catch == 1) %>% 
  plot_pcod_dist("cpue")
```
 
Fit models:

```{r fit-1996-cpue}
areas <- unique(dfleet$area)
formulas <- data_frame(
  formula = c(
    "cpue ~ year_factor",
    "cpue ~ year_factor + depth",
    "cpue ~ year_factor + month",
    "cpue ~ year_factor + latitude",
    "cpue ~ year_factor + locality",
    "cpue ~ year_factor + vessel",
    "cpue ~ year_factor + depth + month + latitude + locality + vessel"
  ),
  formula_version = c(
    "Unstandardized",
    "Depth",
    "Month",
    "Latitude",
    "Locality",
    "Vessel",
    "Full standardization"
  )
)
torun <- expand.grid(formula = formulas$formula,
  area = areas, stringsAsFactors = FALSE)
torun <- inner_join(torun, formulas, by = "formula")

fi2 <- here::here("data/1996-cpue-models.rds")
if (!file.exists(fi2)) {
  m1996_re <- plyr::mlply(torun[1:2,],
    function(formula, area, formula_version) {
    df <- dfleet[dfleet$area == area, , drop = FALSE]
    df <- droplevels(df)
    message("Fitting area ", area, " and model ", formula)
    fit_cpue_index_tweedie(df, formula = as.formula(formula))
  })
  readr::write_rds(m1996_re, fi2)
} else {
  m1996_re <- readr::read_rds(fi2)
}

predictions_1996_re <- plyr::ldply(m1996_re, predict_cpue_index_tweedie)
saveRDS(predictions_1996_re,
  file = here::here("data/cpue-1996-predictions.rds")
)
```

Plot coefs:

```{r coef-plot, fig.asp=1.7}
toplot <- which(attr(
  m1996_re, "split_labels")$formula_version == "Full standardization")
areas_plot <- unique(attr(m1996_re, "split_labels")$area)
plot_cpue_index_coefs(m1996_re[[toplot[1]]], type = "tweedie", 
  re_name = c("RE locality", "RE vessel")) + ggtitle(areas_plot[1])
```

Plot comparison of indices:

```{r cpue-modern-predictions}
arith_cpue_1996 <- dfleet %>%
  group_by(area, year) %>%
  summarise(est = sum(spp_catch) / sum(hours_fished)) %>%
  mutate(model = "Combined") %>%
  group_by(area) %>%
  mutate(geo_mean = exp(mean(log(est)))) %>%
  mutate(est = est/geo_mean) %>%
  ungroup()

plot_re_predictions(predictions_1996_re, "Combined", scale = TRUE) +
  geom_line(data = arith_cpue_1996, aes(year, est),
    inherit.aes = FALSE, lty = 2) +
  scale_x_continuous(breaks = seq(1990, 2050, 10)) +
  facet_wrap(~formula_version)
```

Zoom in on fully standardized:

```{r predictions-stand}
predictions_1996_re %>% 
  filter(formula_version %in% c("Unstandardized", "Full standardization")) %>% 
  plot_re_predictions("Combined", scale = TRUE) +
  geom_line(data = arith_cpue_1996, aes(year, est),
    inherit.aes = FALSE, lty = 2) +
  scale_x_continuous(breaks = seq(1990, 2050, 10))
```

